 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.83">
    <title>o-Maps: –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
    <meta name="description" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –û-—Å—Ç–∞—Ä—Ç–æ–≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞.">
    <link rel="icon" type="image/png" href="favicon.png"/>
    <link href='./css/google-fonts.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css"/>

    <meta property="og:title" content="o-Maps: –ö–∞–ª–µ–Ω–¥–∞—Ä—å">
    <meta property="og:site_name" content="–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã: –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–æ–≥–µ–π–Ω">
    <meta property="og:url" content="https://o-maps.spb.ru/">
    <meta property="og:description" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –û-—Å—Ç–∞—Ä—Ç–æ–≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞.">

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(99914151, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/99914151" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <base target="_blank">
</head>
<body class="stat-body sheet-body calendar-body">
    <a href="spb.html" target="_self" class="stat-map-link stat-map-link-right" title="–ö–∞—Ä—Ç–∞"><img src="images/map_24.png" alt="–ö–∞—Ä—Ç–∞" /></a>
    <h1>
         <a href="./index.html" target="_self" title="–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">O-maps ‚ó™</a>

        <select class="header_selector" onchange="selectMapRegion(this.value, 'sheet')">
            <option value="index">–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</option>
            <option disabled>‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ</option>
            <option value="spb">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
            <option value="msk">–ú–æ—Å–∫–≤–∞</option>
            <option value="rzn">–†—è–∑–∞–Ω—å</option>
            <option value="smr">–°–∞–º–∞—Ä–∞</option>
            <option value="srb">–ë–µ–ª–≥—Ä–∞–¥</option>
            <option value="all">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –≤–º–µ—Å—Ç–µ</option>
            <option disabled>‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ</option>
            <option value="docs">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</option>
            <option value="tracks">–ú–∞—Ä—à—Ä—É—Ç—ã</option>
            <option value="calendar" selected>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ-—Å—Ç–∞—Ä—Ç–æ–≤</option>
        </select>

        <select id="event_type_selector" class="header_selector" onchange="selectEventType(this.value)">
            <option value="ALL">–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</option>
            <option value="ORIENT">–û—Ä–∏–µ–Ω—Ç</option>
            <option value="ROGAINE">–†–æ–≥–µ–π–Ω</option>
            <option value="SKI">–õ—ã–∂–∏</option>
            <option value="VELO">–í–µ–ª–æ</option>
            <option value="OTHER">–ü—Ä–æ—á–µ–µ</option>
        </select>

<!--
        <label for="event_month_selector">–ú–µ—Å—è—Ü:</label>
        <select id="event_month_selector" class="header_selector" onchange="selectEventMonth(this.value)">
            <option value="0">–≤—Å–µ</option>
            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
            <option value="3">–ú–∞—Ä—Ç</option>
            <option value="4">–ê–ø—Ä–µ–ª—å</option>
            <option value="5">–ú–∞–π</option>
            <option value="6">–ò—é–Ω—å</option>
            <option value="7">–ò—é–ª—å</option>
            <option value="8">–ê–≤–≥—É—Å—Ç</option>
            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
            <option value="11">–ù–æ—è–±—Ä—å</option>
            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
        </select>
-->
    </h1>
    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ-—Å—Ç–∞—Ä—Ç–æ–≤ –°–ü–±</h2>

    <div class="o-sheet-roof">
        <a href="#" onclick="downloadSheetTable('o-maps-calendar.csv')" target="_self" title="–°–∫–∞—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É"><img src="images/download_24.png" /></a>
    </div>
    <div class="o-sheet-wrapper">
        <table class="o-main-table o-sheet">
            <thead>
            <tr>
                <th>&nbsp</th>
                <th data-sort="date" class="sortable" data-order="desc">–î–∞—Ç–∞</th>
                <th data-sort="name" class="sortable">–°—Ç–∞—Ä—Ç / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                <th data-sort="place" class="sortable">–ú–µ—Å—Ç–æ</th>
                <th>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞ / —Ñ–æ—Ä–º–∞—Ç</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</th>
                <th>–¢—Ä–∞–Ω—Å–ª—è—Ü–∏–∏</th>
                <th>–ü—Ä–æ—á–µ–µ</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="js/ext/jquery.slim.min.js"></script>

    <script src="js/calendar-2025.js"></script>
    <script src="js/calendar-2026.js"></script>

    <script src="js/maps-starts-schools.js"></script>
    <script src="js/maps-city.js"></script>
    <script src="js/maps-parks.js"></script>
    <script src="js/maps-forest.js"></script>
    <script src="js/maps-forest-vsevolozhsk.js"></script>
    <script src="js/maps-forest-south.js"></script>
    <script src="js/maps-forest-priozersk.js"></script>
    <script src="js/maps-forest-zelik.js"></script>
    <script src="js/maps-forest-toksovo.js"></script>
    <script src="js/maps-forest-sosnovo.js"></script>
    <script src="js/maps-forest-michura.js"></script>
    <script src="js/maps-forest-vaskelovo.js"></script>
    <script src="js/maps-forest-vyborg.js"></script>
    <script src="js/maps-special.js"></script>
    <script src="js/maps-fun.js"></script>
    <script src="js/maps-rogaine.js"></script>
    <script src="js/maps-rogaine-beketov.js"></script>
    <script src="js/maps-rogaine-kkm.js"></script>
    <script src="js/maps-rogaine-rfar.js"></script>

    <script src="js/owners.js"></script>
    <script src="js/starts.js"></script>
    <script src="js/welcome.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/utils-common.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let EVENT_TYPE_PARAM = urlParams.get('event-type');
        let EVENT_MONTH_PARAM = urlParams.get('event-month');

        let loadImagesRequired = false;
        let mapsOnStore = false;
        let documentsPage = true;
        let currentSort = 'date';

        let oMaps = [
            ...rogaineRfarMaps,
            ...rogaineBeketovMaps,
            ...rogaineKkmMaps,
            ...rogaineMaps,
            ...funMaps,
            ...specialMaps,
            ...forestMaps,
            ...vsevolozhskMaps,
            ...southMaps,
            ...priozerskMaps,
            ...zelikMaps,
            ...vyborgMaps,
            ...sosnovoMaps,
            ...michuraMaps,
            ...vaskelovoMaps,
            ...toksovoMaps,
            ...parkMaps,
            ...cityMaps,
            ...schoolMaps,
        ];

        let oEvents = [
            ...events_2025,
            ...events_2026,
        ];

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞. –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç–≤–µ–Ω—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–¥–∏ –æ–Ω –∑–∞–¥–∞–Ω).
        if (EVENT_TYPE_PARAM && ('ALL' !== EVENT_TYPE_PARAM)) {
            oEvents = oEvents.filter(event => {
                if ('ROGAINE' === EVENT_TYPE_PARAM) {
                    return isRogaine(event);
                }
                if ('ORIENT' === EVENT_TYPE_PARAM) {
                    return event.type.includes('ORIENT');
                }
                if ('OTHER' === EVENT_TYPE_PARAM) {
                    return !event.type.includes('ORIENT') && !event.type.includes('VELO') && !event.type.includes('SKI') && !isRogaine(event);
                }
                if ('SKI' === EVENT_TYPE_PARAM) {
                    return event.type.includes('SKI');
                }
                if ('VELO' === EVENT_TYPE_PARAM) {
                    return event.type.includes('VELO');
                }
            });

            let selector = document.getElementById('event_type_selector');
            selector.value = EVENT_TYPE_PARAM;
        }
        if (EVENT_MONTH_PARAM && ('0' !== EVENT_MONTH_PARAM)) {
            oEvents = oEvents.filter(event => {
                const date = new Date(event.date);
                const month = date.getMonth() + 1;
                return month.toString() === EVENT_MONTH_PARAM;
            });

            let selector = document.getElementById('event_month_selector');
            selector.value = EVENT_MONTH_PARAM;
        }

        window.onload = function() {
/*
            oEvents.sort((a, b) => (a.info || '').localeCompare(b.info || ''))
                .sort((a, b) => (a.startYear || (a.year || 0)) - (b.startYear || (b.year || 0)));
*/
            // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            document.querySelectorAll('th.sortable').forEach(
                (element) => {
                    element.addEventListener('click', sortEventsTable);
                }
            );

            // –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
            renderMapsTable();

            setTimeout(() => {
                const firstCurrent = document.querySelector('.current').previousSibling;
                firstCurrent.scrollIntoView();
            }, 1000);

            // --- welcome dialog ---
            writeWelcomeButton();
        }

        // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
        const tbody = document.querySelector('.o-main-table tbody');
        const DAY_TIME_RANGE = 1000 * 60 * 60 * 24;
        const WEEK_TIME_RANGE = DAY_TIME_RANGE * 7;

        let currentDate;
        let monthTD = null, prevDate = null;
        let korients = 0, krogaines = 0, kothers = 0;

        // —Å—Ç—Ä–æ–∏—Ç —Ç–∞–±–ª–∏—á–∫—É —Å –∏–Ω—Ñ–æ–π –æ–± –∞–≤—Ç–æ—Ä–∞—Ö-—Å–æ—Å—Ç–∞–≤–∏—Ç–µ–ª—è—Ö
        function renderMapsTable() {
            tbody.innerHTML = '';

            let idx = 0;
            let prevYear = 0;
            let currentMonth = -1;
            for (const event of oEvents) {
                currentDate = new Date(event.date);
                let month = currentDate.getMonth();
                if (currentSort === 'date' && month !== currentMonth) {
                    if (monthTD) {
                        buildMonth();
                    }
                    currentMonth = month;
                    const monthRow = document.createElement('tr');
                    monthTD = document.createElement('td');
                    monthTD.setAttribute('colspan', 8);
                    monthTD.classList.add('month-row');
                    monthRow.appendChild(monthTD);
                    tbody.appendChild(monthRow);
                }
                const row = document.createElement('tr');
                let now = new Date();
                if ((currentDate < now) && (Math.abs(currentDate - now) > DAY_TIME_RANGE)) {
                    row.classList.add('disabled');
                } else {
                    if (currentDate - now < WEEK_TIME_RANGE) {
                        row.classList.add('current');
                    }
                }
                if(event.cancelled) {
                    row.classList.add('cancelled');
                }
                if (event.type.includes('WATER')) {
                    row.classList.add('water');
                    krogaines++;
                } else if (event.type.includes('ORIENT')) {
                    row.classList.add('orient');
                    korients++;
                } else if (isRogaine(event)) {
                    row.classList.add('rogaine');
                    krogaines++;
                } else {
                    if (event.type.includes('SKI') || event.type.includes('VELO')) {
                        korients++;
                    } else {
                        kothers++;
                    }
                }
                const y = currentDate.getFullYear();
                if (y !== prevYear) {
                    prevYear = y;
                    idx = 0;
                }
                td(row, buildNumber(event, idx++));
                td(row, buildEventDate(event));
                td(row, buildEventStart(event));
                td(row, buildPlace(event));
                td(row, buildEventType(event, true));
                td(row, buildEventResults(event));
                td(row, buildEventReports(event, true));
                td(row, event.info ?? '');
                tbody.appendChild(row);

                prevDate = currentDate;
            }
            buildMonth();
            document.body.style.cursor = 'default';
        }

        function buildMonth() {
            let year = prevDate.getFullYear();
            let monthName = prevDate.toLocaleString('ru', { month: 'long' }).toUpperCase().split('').join(' ');
            monthTD.innerHTML = `${monthName}&nbsp;&nbsp;&nbsp;${year}&nbsp;&nbsp;&nbsp;(–æ—Ä–∏–µ–Ω—Ç—ã: ${korients}, —Ä–æ–≥–µ–π–Ω—ã: ${krogaines}, –ø—Ä–æ—á–∏–µ: ${kothers})`;
            korients = krogaines = kothers = 0;
        }

        function td(row, html) {
            const td = document.createElement('td');
            td.innerHTML = html;
            row.appendChild(td);
        }

        function buildNumber(event, i) {
            let icon = '';
            if (event.type.includes('SKI')) {
                icon = '&nbsp;‚ùÑ';
            } else if (event.type.includes('VELO')) {
                icon = '&nbsp;üö≤';
            } else if (event.type.includes('WATER')) {
                icon = '&nbsp;üö£';
            }
            return (i + 1) + icon;
        }

        function buildPlace(event) {
            if (event.map) {
                let maps = Array.isArray(event.map) ? [...event.map] : [event.map];
                let result = '';
                for (const [i, m] of maps.entries()) {
                    if (i === 0) {
                        result = buildLink('spb.html?map=' + m, event.place + ' üó∫Ô∏è', '–ö–∞—Ä—Ç–∞ –Ω–∞ o-Maps');
                    } else {
                        result += buildLink('spb.html?map=' + m, ' üó∫Ô∏è', '–ö–∞—Ä—Ç–∞ –Ω–∞ o-Maps');
                    }
                }
                return result;
            } else {
                return event.place ?? '';
            }
        }

        function selectEventType(type) {
            if (type === 'ALL') {
                location.href = './calendar.html';
            } else {
                location.href = './calendar.html?event-type=' + type;
            }
        }

        function selectEventMonth(month) {
            if (month === '0') {
                location.href = './calendar.html';
            } else {
                location.href = './calendar.html?event-month=' + month;
            }
        }

        function sortEventsTable() {
            document.body.style.cursor = 'wait';

            const sortable = document.querySelector('.o-sheet th.sortable[data-order="asc"], .o-sheet th.sortable[data-order="desc"]');
            if (sortable !== this) {
                sortable.dataset.order = '';
            }

            const isAscending = this.dataset.order === 'asc';
            currentSort = this.dataset.sort;
            switch (currentSort) {
                case 'name':
                    oEvents.sort((a, b) => {
                        return isAscending ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                    });
                    break;
                case 'date':
                    oEvents.sort((a, b) => {
                        return isAscending ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date);
                    });
                    break;
                case 'place':
                    oEvents.sort((a, b) => {
                        return isAscending ? (a.place || '').localeCompare(b.place) : (b.place || '').localeCompare(a.place);
                    });
                    break;
            }
            this.dataset.order = isAscending ? 'desc' : 'asc';
            renderMapsTable();
        }
    </script>
</body>
</html>
