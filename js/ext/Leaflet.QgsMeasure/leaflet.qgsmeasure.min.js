const e=window.L;e.Polyline.Measure=e.Draw.Polyline.extend({addHooks(){e.Draw.Polyline.prototype.addHooks.call(this),this._map&&(this._markerGroup=new e.LayerGroup,this._map.addLayer(this._markerGroup),this._segments=[],this._markers=[],this._map.on("click",this._onClick,this),this._startShape())},removeHooks(){e.Draw.Polyline.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._map.off("pointermove",this._onMouseMove,this).off("mousemove",this._onMouseMove,this).off("click",this._onClick,this),this._clearGuides(),this._container.style.cursor="",this._removeShape()},_startShape(){this._drawing=!0,this._poly=new e.Polyline([],this.options.shapeOptions),this._poly._onClick=()=>{},this._container.style.cursor="crosshair",this._updateTooltip(),this._map.on("pointermove",this._onMouseMove,this).on("mousemove",this._onMouseMove,this)},_finishShape(){this._drawing=!1,this._cleanUpShape(),this._clearGuides(),this._updateTooltip(),this._map.off("pointermove",this._onMouseMove,this).off("mousemove",this._onMouseMove,this),this._container.style.cursor=""},_removeShape(){this._poly&&(this._map.removeLayer(this._poly),delete this._poly,this._markers.splice(0),this._markerGroup.clearLayers(),this._clearSegments())},_onClick(e){this._markers.length>1&&this._drawing&&(this._addSegment(),this._updateSegmentsTooltipNumber()),this._drawing||(this._removeShape(),this._startShape(),this._map.fire("qgsmeasure:newmeasure"))},getSegments(){return this._segments},_updateSegmentsTooltipNumber(){let t=1;for(const s of this._markers)s.bindTooltip(`${t}`,{permanent:!0,offset:e.point(6,0),opacity:1}).openTooltip(),t+=1},_addSegment(){let e=this._markers.at(-2).getLatLng(),t=this._markers.at(-1).getLatLng();const s=this._map.distance(e,t),i={from:this._markers.length-1,to:this._markers.length,distance:s};this._segments.push(i),this._map.fire("qgsmeasure:newsegment",{segment:i,segments:this._segments})},_clearSegments(){this._segments=[]},_getTooltipText(){let t=e.Draw.Polyline.prototype._getTooltipText.call(this);return this._drawing||(t.text=""),t}}),e.Control.QgsMeasure=e.Control.extend({options:{position:"topleft",shapeOptions:{color:"#d07f03",stroke:!0,weight:4,opacity:.7,fill:!1,clickable:!0},icon:new e.DivIcon({iconSize:new e.Point(9,9),className:"leaflet-div-icon leaflet-editing-icon"}),text:{title:"Measure distances",segments_title:"Segments (meters)",segments_from:"From ",segments_to:"to ",segments_total:"Total: ",segments_meters:"m"}},initialize(t){(t=t||{}).text=e.Util.extend(this.options.text,t.text),e.Util.setOptions(this,t)},enabled(){return this._handler.enabled()},toggle(){this._handler.enabled()?(this._map.fire("qgsmeasure:measurestop"),this._handler.disable.call(this._handler)):(this._map.fire("qgsmeasure:measurestart"),this._handler.enable.call(this._handler))},getSegments(){return this._handler.getSegments()},_createTextElement(t,s,i,n){e.DomUtil.create(t,s,i).innerText=n},_createSegmentContainer(){if(this._segments_container)return;const[t]=document.getElementsByClassName("leaflet-top leaflet-right");this._segments_container=e.DomUtil.create("div","segments-container leaflet-control",t),e.DomEvent.disableScrollPropagation(this._segments_container),this._createTextElement("span","segments-title",this._segments_container,this.options.text.segments_title),this._segments_measures_container=e.DomUtil.create("div","segments-measures-container",this._segments_container),this._segments_total_distance_container=e.DomUtil.create("div","segments-total-distance-container",this._segments_container),this._total_distance_text_reset=`${this.options.text.segments_total} 0 ${this.options.text.segments_meters}`,this._createTextElement("span","",this._segments_total_distance_container,this._total_distance_text_reset),this._total_distance_text_element=document.getElementsByClassName("segments-total-distance-container")[0].firstChild},_startMeasure(e){let{segments:t}=e;const s=t.at(-1),i=this.options.text.segments_from,n=this.options.text.segments_to,o=this.options.text.segments_meters;let a=t.reduce(((e,t)=>e+t.distance),0);const r=`${i} ${s.from} ${n} ${s.to} = ${s.distance.toFixed(2)} ${o}`;this._createTextElement("span","segment-measure",this._segments_measures_container,r),this._total_distance_text_element.innerText=`${this.options.text.segments_total} ${a.toFixed(3)} ${this.options.text.segments_meters}`,this._segments_container.scrollTop=this._segments_measures_container.scrollHeight},_finishMeasure(){for(;this._segments_measures_container.firstChild;)this._segments_measures_container.removeChild(this._segments_measures_container.firstChild);this._total_distance_text_element.innerText=this._total_distance_text_reset},onAdd(t){if(this._handler=new e.Polyline.Measure(t,this.options),this.options.button)return e.DomEvent.on(this.options.button,"click",this.toggle,this),e.DomUtil.create("div","leaflet-bar");this._map.on("qgsmeasure:measurestart",this._createSegmentContainer,this),this._map.on("qgsmeasure:newsegment",this._startMeasure,this),this._map.on("qgsmeasure:newmeasure",this._finishMeasure,this),this._handler.on("enabled",(()=>{e.DomUtil.addClass(this._segments_container,"show")}),this),this._handler.on("disabled",(()=>{e.DomUtil.removeClass(this._segments_container,"show"),this._finishMeasure()}),this);let s=null;return this._container=e.DomUtil.create("div","leaflet-bar"),s=e.DomUtil.create("a","leaflet-control-draw-measure",this._container),s.href="#",s.title=this.options.text.title,e.DomEvent.addListener(s,"click",e.DomEvent.stopPropagation).addListener(s,"click",e.DomEvent.preventDefault).addListener(s,"click",this.toggle,this),this._container},onRemove(){this.options.button&&e.DomEvent.off(this.options.button,"click",this.toggle,this)}}),e.Map.mergeOptions({measureControl:!1}),e.Map.addInitHook((function(){this.options.measureControl&&(this.measureControl=e.Control.qgsmeasure().addTo(this))})),e.Control.qgsmeasure=t=>new e.Control.QgsMeasure(t);